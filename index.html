<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Liegestütz Tracker</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #121212;
    color: #7df9ff;
    margin: 0;
    padding: 20px;
    transition: background-color 0.3s, color 0.3s;
  }
  body.light-mode {
    background-color: #f0f0f0;
    color: #007f7f;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #settings-icon {
    cursor: pointer;
    font-size: 24px;
    user-select: none;
    color: inherit;
  }
  #settings-menu {
    position: absolute;
    top: 50px;
    right: 20px;
    background: rgba(0,0,0,0.8);
    border-radius: 8px;
    padding: 15px;
    display: none;
    width: 220px;
    color: #7df9ff;
    z-index: 100;
  }
  body.light-mode #settings-menu {
    background: #ddd;
    color: #007f7f;
  }
  #notification-toggle-menu {
    margin-top: 10px;
    background: rgba(0,0,0,0.6);
    padding: 10px;
    border-radius: 6px;
    display: none;
  }
  body.light-mode #notification-toggle-menu {
    background: #bbb;
  }
  label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
  }
  input[type="checkbox"] {
    transform: scale(1.3);
  }
  select, input[type="number"], input[type="text"] {
    width: 100%;
    margin-top: 5px;
    margin-bottom: 15px;
    padding: 5px;
    border-radius: 4px;
    border: 1px solid #007f7f;
    background-color: transparent;
    color: inherit;
  }
  body.light-mode select, body.light-mode input[type="number"], body.light-mode input[type="text"] {
    border-color: #007f7f;
    background-color: #fff;
    color: #007f7f;
  }
  button {
    background-color: #00ffcc;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    color: #004d40;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  button:hover {
    background-color: #00cc99;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th, td {
    padding: 8px;
    border-bottom: 1px solid #007f7f;
    text-align: center;
  }
  body.light-mode th, body.light-mode td {
    border-color: #004d40;
  }
  #progress-bar-container {
    width: 100%;
    background-color: #444;
    border-radius: 12px;
    overflow: hidden;
    margin-top: 20px;
    height: 25px;
  }
  #progress-bar {
    height: 100%;
    background-color: #00ffcc;
    width: 0%;
    transition: width 0.5s ease-in-out;
  }
  #chart-container {
    margin-top: 30px;
  }
</style>
</head>
<body class="dark-mode">
<header>
  <h1>Liegestütz Tracker</h1>
  <div id="settings-icon" title="Einstellungen">&#9881;</div>
</header>

<div id="settings-menu" role="menu" aria-label="Einstellungen Menü">
  <label for="dark-toggle">
    <input type="checkbox" id="dark-toggle" />
    Dark Mode aktivieren
  </label>

  <label for="date-filter">
    Zeitraum filtern:
    <select id="date-filter" aria-label="Zeitraum Filter">
      <option value="all">Alle Einträge</option>
      <option value="7">Letzte 7 Tage</option>
      <option value="30">Letzte 30 Tage</option>
      <option value="90">Letzte 90 Tage</option>
    </select>
  </label>

  <label for="daily-target">
    Tagesziel Liegestütze:
    <input type="number" id="daily-target" min="1" max="1000" />
  </label>

  <label for="font-select">
    Schriftart:
    <select id="font-select" aria-label="Schriftart Auswahl">
      <option value="Arial, sans-serif">Arial</option>
      <option value="'Courier New', monospace">Courier New</option>
      <option value="'Georgia', serif">Georgia</option>
      <option value="'Times New Roman', serif">Times New Roman</option>
      <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
      <option value="'Verdana', sans-serif">Verdana</option>
    </select>
  </label>

  <label id="notification-toggle" style="cursor:pointer; user-select:none;">
    Benachrichtigungen &nbsp;&#x25BC;
  </label>
  <div id="notification-toggle-menu" role="menu" aria-label="Benachrichtigungs Optionen">
    <label for="enable-notifications">
      <input type="checkbox" id="enable-notifications" />
      Benachrichtigungen aktivieren
    </label>
  </div>

  <button id="export-btn" aria-label="Daten exportieren">Daten exportieren</button>
</div>

<div style="margin-top: 20px;">
  <input type="text" id="search-input" placeholder="Nach Datum suchen (TT.MM.JJJJ)" aria-label="Datum Suche" />
</div>

<table aria-label="Eingabedaten Tabelle" id="data-table">
  <thead>
    <tr><th>Datum</th><th>Liegestütze</th></tr>
  </thead>
  <tbody>
  </tbody>
</table>

<div id="progress-bar-container" aria-label="Fortschrittsbalken">
  <div id="progress-bar"></div>
</div>

<div id="chart-container">
  <canvas id="progress-chart" aria-label="Fortschrittsdiagramm"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const settingsIcon = document.getElementById('settings-icon');
  const settingsMenu = document.getElementById('settings-menu');
  const notificationToggle = document.getElementById('notification-toggle');
  const notificationToggleMenu = document.getElementById('notification-toggle-menu');
  const enableNotificationsCheckbox = document.getElementById('enable-notifications');
  const darkToggle = document.getElementById('dark-toggle');
  const dateFilter = document.getElementById('date-filter');
  const dailyTargetInput = document.getElementById('daily-target');
  const fontSelect = document.getElementById('font-select');
  const exportBtn = document.getElementById('export-btn');
  const searchInput = document.getElementById('search-input');
  const dataTableBody = document.querySelector('#data-table tbody');
  const progressBar = document.getElementById('progress-bar');
  const ctx = document.getElementById('progress-chart').getContext('2d');

  let allInputs = [];
  let dailyTarget = 30;
  let progressChart = null;

  // Beispiel-Daten (kann leer sein, falls eigene Daten gewünscht)
  if (!localStorage.getItem('liegestuetzData')) {
    allInputs = [
      { date: '01.06.2025', value: '20' },
      { date: '02.06.2025', value: '25' },
      { date: '03.06.2025', value: '30' },
      { date: '04.06.2025', value: '35' },
      { date: '05.06.2025', value: '40' },
    ];
    localStorage.setItem('liegestuetzData', JSON.stringify(allInputs));
  }

  function parseDateString(str) {
    const parts = str.split('.');
    if (parts.length !== 3) return null;
    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10) - 1;
    const year = parseInt(parts[2], 10);
    return new Date(year, month, day);
  }

  function loadData() {
    const saved = localStorage.getItem('liegestuetzData');
    if (saved) {
      allInputs = JSON.parse(saved);
    }
    const savedTarget = localStorage.getItem('dailyTarget');
    if (savedTarget) {
      dailyTarget = parseInt(savedTarget);
      dailyTargetInput.value = dailyTarget;
    } else {
      dailyTargetInput.value = dailyTarget;
    }
    const darkMode = localStorage.getItem('darkMode');
    if (darkMode === 'true') {
      darkToggle.checked = true;
      document.body.classList.remove('light-mode');
    } else {
      darkToggle.checked = false;
      document.body.classList.add('light-mode');
    }
    const savedFont = localStorage.getItem('fontFamily');
    if (savedFont) {
      fontSelect.value = savedFont;
      document.body.style.fontFamily = savedFont;
    }
    const notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
    enableNotificationsCheckbox.checked = notificationsEnabled;
  }

  function saveData() {
    localStorage.setItem('liegestuetzData', JSON.stringify(allInputs));
    localStorage.setItem('dailyTarget', dailyTarget);
    localStorage.setItem('darkMode', darkToggle.checked);
    localStorage.setItem('fontFamily', fontSelect.value);
    localStorage.setItem('notificationsEnabled', enableNotificationsCheckbox.checked);
  }

  function updateTable(searchDate = '') {
    dataTableBody.innerHTML = '';
    const filtered = searchDate
      ? allInputs.filter(e => e.date === searchDate)
      : applyDateFilter(allInputs);

    filtered.sort((a, b) => {
      const d1 = parseDateString(a.date);
      const d2 = parseDateString(b.date);
      return d1 - d2;
    });

    if (filtered.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 2;
      td.textContent = 'Keine Einträge gefunden.';
      td.style.textAlign = 'center';
      tr.appendChild(td);
      dataTableBody.appendChild(tr);
      return;
    }

    for (const e of filtered) {
      const tr = document.createElement('tr');
      const tdDate = document.createElement('td');
      tdDate.textContent = e.date;
      const tdValue = document.createElement('td');
      tdValue.textContent = e.value;
      tr.appendChild(tdDate);
      tr.appendChild(tdValue);
      dataTableBody.appendChild(tr);
    }
  }

  function applyDateFilter(data) {
    const val = dateFilter.value;
    if (val === 'all') return data;
    const days = parseInt(val);
    const now = new Date();
    return data.filter(e => {
      const entryDate = parseDateString(e.date);
      if (!entryDate) return false;
      const diffTime = now - entryDate;
      const diffDays = diffTime / (1000 * 60 * 60 * 24);
      return diffDays >= 0 && diffDays < days;
    });
  }

  function updateStats() {
    // Berechne durchschnittliche Liegestütze pro Tag im gefilterten Zeitraum
    const filtered = applyDateFilter(allInputs);
    if (filtered.length === 0) return;
    let total = 0;
    for (const e of filtered) {
      total += parseInt(e.value) || 0;
    }
    const avg = total / filtered.length;
    // Du kannst hier noch weitere Statistiken hinzufügen
  }

  function updateProgressBar() {
    const filtered = applyDateFilter(allInputs);
    if (filtered.length === 0) {
      progressBar.style.width = '0%';
      return;
    }
    const today = new Date();
    const todayStr = `${String(today.getDate()).padStart(2,'0')}.${String(today.getMonth()+1).padStart(2,'0')}.${today.getFullYear()}`;
    const todayEntry = filtered.find(e => e.date === todayStr);
    let valueToday = 0;
    if (todayEntry) valueToday = parseInt(todayEntry.value) || 0;
    let progress = (valueToday / dailyTarget) * 100;
    if (progress > 100) progress = 100;
    progressBar.style.width = progress + '%';
  }

  function updateChart() {
    const filteredData = applyDateFilter(allInputs);
    filteredData.sort((a, b) => {
      const d1 = parseDateString(a.date);
      const d2 = parseDateString(b.date);
      return d1 - d2;
    });

    const labels = filteredData.map(e => e.date);
    const dataValues = filteredData.map(e => parseInt(e.value) || 0);

    if (progressChart) {
      progressChart.destroy();
    }
    progressChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Liegestütze',
          data: dataValues,
          fill: true,
          borderColor: '#00ffcc',
          backgroundColor: 'rgba(0, 255, 204, 0.2)',
          tension: 0.3,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: '#00ffcc',
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            labels: {
              color: document.body.classList.contains('light-mode') ? '#007f7f' : '#7df9ff'
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: document.body.classList.contains('light-mode') ? '#007f7f' : '#7df9ff',
            },
            grid: {
              color: document.body.classList.contains('light-mode') ? '#ccc' : '#444',
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              color: document.body.classList.contains('light-mode') ? '#007f7f' : '#7df9ff',
            },
            grid: {
              color: document.body.classList.contains('light-mode') ? '#ccc' : '#444',
            }
          }
        }
      }
    });
  }

  // --- Event Listeners ---

  settingsIcon.addEventListener('click', () => {
    if (settingsMenu.style.display === 'block') {
      settingsMenu.style.display = 'none';
      notificationToggleMenu.style.display = 'none';
    } else {
      settingsMenu.style.display = 'block';
    }
  });

  notificationToggle.addEventListener('click', () => {
    if (notificationToggleMenu.style.display === 'block') {
      notificationToggleMenu.style.display = 'none';
    } else {
      notificationToggleMenu.style.display = 'block';
    }
  });

  enableNotificationsCheckbox.addEventListener('change', () => {
    saveData();
  });

  darkToggle.addEventListener('change', () => {
    if (darkToggle.checked) {
      document.body.classList.remove('light-mode');
    } else {
      document.body.classList.add('light-mode');
    }
    updateChart();
    saveData();
  });

  dateFilter.addEventListener('change', () => {
    updateTable();
    updateStats();
    updateProgressBar();
    updateChart();
  });

  dailyTargetInput.addEventListener('input', () => {
    let val = parseInt(dailyTargetInput.value);
    if (isNaN(val) || val < 1) val = 1;
    if (val > 1000) val = 1000;
    dailyTarget = val;
    dailyTargetInput.value = val;
    updateStats();
    updateProgressBar();
    saveData();
  });

  fontSelect.addEventListener('change', () => {
    document.body.style.fontFamily = fontSelect.value;
    saveData();
  });

  exportBtn.addEventListener('click', () => {
    const dataStr = JSON.stringify(allInputs, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'liegestuetz-data.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      const searchDate = searchInput.value.trim();
      if (searchDate) {
        updateTable(searchDate);
        updateStats();
        updateProgressBar();
        updateChart();
      }
    }
  });

  // Schließe das Settings-Menü, wenn man irgendwo anders klickt
  document.addEventListener('click', (e) => {
    if (!settingsMenu.contains(e.target) && e.target !== settingsIcon) {
      settingsMenu.style.display = 'none';
      notificationToggleMenu.style.display = 'none';
    }
  });

  // --- Initialisierung ---
  loadData();
  updateTable();
  updateStats();
  updateProgressBar();
  updateChart();

</script>
</body>
</html>
