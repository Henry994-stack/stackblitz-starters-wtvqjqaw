<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Liegest√ºtz-Tracker</title>
<link rel="apple-touch-icon" href="icon.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<style>
  /* --- Grundstyles --- */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #1c1c1c;
    color: #f0f0f0;
    margin: 20px;
    padding: 0;
    transition: background-color 0.3s, color 0.3s;
  }
  h1 {
    text-align: center;
    color: #00ffcc;
    margin-bottom: 10px;
  }
  /* Einstellungen-Icon */
  #settingsIcon {
    position: fixed;
    top: 10px;
    right: 10px;
    font-size: 40px;
    cursor: pointer;
    z-index: 1000;
    user-select: none;
  }
  /* Men√º */
  #settingsMenu {
    position: fixed;
    top: 60px;
    right: 10px;
    background-color: #2c2c2c;
    border: 1px solid #444;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 0 15px rgba(0, 255, 200, 0.3);
    display: none;
    z-index: 999;
    width: 230px;
    font-size: 14px;
  }
  #settingsMenu ul {
    list-style: none;
    padding: 0;
    margin: 0 0 10px 0;
  }
  #settingsMenu li {
    padding: 8px;
    cursor: pointer;
    color: #7df9ff;
  }
  #settingsMenu li:hover {
    background-color: #444;
  }
  #notificationToggleMenu,
  #fontSelectContainer,
  #targetInputContainer {
    margin-top: 10px;
    color: #fff;
  }
  #notificationToggleMenu label,
  #targetInputContainer label {
    cursor: pointer;
    user-select: none;
  }
  /* Statsbox */
  #statsBox {
    background-color: #262626;
    padding: 20px;
    border-radius: 10px;
    margin: 20px auto;
    max-width: 600px;
    box-shadow: 0 0 15px rgba(0, 255, 200, 0.3);
    border: 1px solid #333;
  }
  #statsBox p {
    margin: 5px 0;
    font-size: 16px;
  }
  #statsBox p strong {
    color: #7df9ff;
  }
  #statsBox em {
    color: #ffd700;
    font-style: normal;
    font-weight: bold;
  }
  /* Suche */
  #searchInput {
    width: 100%;
    max-width: 300px;
    margin: 10px auto 20px;
    display: block;
    padding: 10px;
    font-size: 16px;
    border: none;
    border-radius: 5px;
    background-color: #333;
    color: white;
    box-shadow: 0 0 5px #7df9ff;
  }
  /* Tabelle */
  table {
    width: 100%;
    max-width: 600px;
    margin: 0 auto 20px auto;
    border-collapse: collapse;
  }
  th {
    background-color: #333;
    color: #7df9ff;
    padding: 10px;
  }
  td {
    border-bottom: 1px solid #444;
    padding: 10px;
    text-align: left;
  }
  input[type='text'] {
    width: 80px;
    padding: 6px;
    background-color: #222;
    color: #f0f0f0;
    border: 1px solid #555;
    border-radius: 5px;
    box-shadow: 0 0 5px #444;
    transition: background-color 0.3s, color 0.3s;
  }
  input[type='text']:focus {
    outline: none;
    border-color: #00ffcc;
    box-shadow: 0 0 8px #00ffcc;
    background-color: #003333;
  }
  /* Highlight Animation */
  .highlight {
    animation: blinkHighlight 1.5s ease-out;
  }
  @keyframes blinkHighlight {
    0% { background-color: #ffb347; }
    50% { background-color: #ffd580; }
    100% { background-color: transparent; }
  }
  /* Fortschrittsbalken */
  #progressBarContainer {
    width: 100%;
    max-width: 600px;
    margin: 0 auto 20px;
    background: #444;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 0 10px #00ffcc inset;
  }
  #progressBar {
    height: 25px;
    width: 0%;
    background: linear-gradient(90deg, #00ffcc, #007f7f);
    text-align: right;
    color: #fff;
    font-weight: bold;
    font-size: 14px;
    padding-right: 8px;
    transition: width 0.6s ease;
  }
  /* Responsive */
  @media (max-width: 650px) {
    body {
      margin: 10px;
    }
    #settingsMenu {
      width: 90%;
      right: 5%;
      top: 55px;
    }
    table, #statsBox, #progressBarContainer {
      max-width: 100%;
    }
    #searchInput {
      max-width: 100%;
    }
  }
  /* Dark Mode helle Variante */
  body.light-mode {
    background-color: #fff;
    color: #000;
  }
  body.light-mode input[type='text'] {
    background-color: #f7f7f7;
    color: #000;
    border: 1px solid #ccc;
    box-shadow: none;
  }
  body.light-mode #settingsMenu {
    background-color: #eee;
    color: #000;
    border: 1px solid #bbb;
    box-shadow: 0 0 15px rgba(0, 200, 150, 0.3);
  }
  body.light-mode #settingsMenu li:hover {
    background-color: #ddd;
  }
  /* Chart Container */
  #chartContainer {
    max-width: 600px;
    margin: 10px auto 30px;
    background: #262626;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 0 15px rgba(0, 255, 200, 0.3);
    color: #7df9ff;
  }
  body.light-mode #chartContainer {
    background: #f0f0f0;
    color: #007f7f;
  }
</style>
</head>
<body>
<h1>Liegest√ºtz-Tracker</h1>

<div id="settingsIcon" title="Einstellungen">‚öô</div>
<div id="settingsMenu">
  <ul>
    <li id="notificationToggle">üîî Benachrichtigungen</li>
  </ul>
  <div id="notificationToggleMenu">
    <label>
      <input type="checkbox" id="enableNotifications" /> Benachrichtigungen aktivieren
    </label>
  </div>

  <div id="targetInputContainer">
    <label for="dailyTargetInput">üéØ Tagesziel:</label><br />
    <input type="number" id="dailyTargetInput" min="1" max="1000" step="1" style="width: 60px;" />
  </div>

  <div id="fontSelectContainer">
    <label for="fontSelect">üî§ Schriftart w√§hlen:</label><br />
    <select id="fontSelect" style="width: 100%;">
      <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI (Standard)</option>
      <option value="'Arial Black', Gadget, sans-serif">Arial Black</option>
      <option value="'Courier New', Courier, monospace">Courier New</option>
      <option value="'Georgia', serif">Georgia</option>
      <option value="'Comic Sans MS', cursive, sans-serif">Comic Sans MS</option>
    </select>
  </div>
</div>

<div id="statsBox"></div>

<div style="text-align: center; margin: 10px 0;">
  <button id="exportBtn">üìÅ Daten exportieren</button>
  <label style="margin-left: 20px;">
    <input type="checkbox" id="darkModeToggle" checked /> üåô Dark Mode
  </label>
  <select id="dateFilter" style="margin-left: 20px;">
    <option value="all">Alle</option>
    <option value="7">Letzte 7 Tage</option>
    <option value="30">Letzte 30 Tage</option>
    <option value="365">Letztes Jahr</option>
  </select>
</div>

<div id="progressBarContainer">
  <div id="progressBar">0%</div>
</div>

<div id="chartContainer">
  <canvas id="progressChart" aria-label="Diagramm der Liegest√ºtz-Werte" role="img"></canvas>
</div>

<input type="text" id="searchInput" placeholder="Datum eingeben (z.‚ÄØB. 29.06.2025) & Enter dr√ºcken" />

<table>
  <thead>
    <tr>
      <th>Datum</th>
      <th>Liegest√ºtze</th>
    </tr>
  </thead>
  <tbody id="trackerTable"></tbody>
</table>

<!-- Chart.js einbinden -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const tableBody = document.getElementById('trackerTable');
  const statsBox = document.getElementById('statsBox');
  const searchInput = document.getElementById('searchInput');
  const settingsIcon = document.getElementById('settingsIcon');
  const settingsMenu = document.getElementById('settingsMenu');
  const notificationToggle = document.getElementById('notificationToggle');
  const notificationToggleMenu = document.getElementById('notificationToggleMenu');
  const enableNotificationsCheckbox = document.getElementById('enableNotifications');
  const darkToggle = document.getElementById('darkModeToggle');
  const exportBtn = document.getElementById('exportBtn');
  const dateFilter = document.getElementById('dateFilter');
  const progressBar = document.getElementById('progressBar');
  const dailyTargetInput = document.getElementById('dailyTargetInput');
  const fontSelect = document.getElementById('fontSelect');

  // F√ºr Chart
  const ctx = document.getElementById('progressChart').getContext('2d');
  let progressChart;

  const startDate = new Date();
  const endDate = new Date(startDate);
  endDate.setFullYear(endDate.getFullYear() + 5);

  const allInputs = [];
  // Tagesziel default (falls nicht gesetzt)
  let dailyTarget = parseInt(localStorage.getItem('dailyTarget')) || 50;

  // --- Helferfunktionen ---
  function formatDate(date) {
    const d = String(date.getDate()).padStart(2, '0');
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const y = date.getFullYear();
    return ${d}.${m}.${y};
  }
  function parseDateString(str) {
    // Erlaubt dd.mm.yyyy und yyyy-mm-dd
    if (/^\d{2}\.\d{2}\.\d{4}$/.test(str)) {
      const [d,m,y] = str.split('.');
      return new Date(${y}-${m}-${d});
    }
    if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
      return new Date(str);
    }
    return null;
  }
  function showNotification(message) {
    if (enableNotificationsCheckbox.checked && "Notification" in window) {
      if (Notification.permission === "granted") {
        new Notification(message);
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
          if (permission === "granted") new Notification(message);
        });
      }
    }
  }
  function saveData() {
    localStorage.setItem('liegestuetzData', JSON.stringify(allInputs));
    localStorage.setItem('dailyTarget', dailyTarget);
    localStorage.setItem('darkMode', darkToggle.checked ? 'dark' : 'light');
    localStorage.setItem('fontFamily', fontSelect.value);
  }
  function loadData() {
    const data = localStorage.getItem('liegestuetzData');
    if (data) {
      const parsed = JSON.parse(data);
      if (Array.isArray(parsed)) {
        allInputs.length = 0;
        parsed.forEach(e => allInputs.push(e));
      }
    }
    const storedTarget = localStorage.getItem('dailyTarget');
    if (storedTarget) dailyTarget = parseInt(storedTarget);

    const darkMode = localStorage.getItem('darkMode');
    if (darkMode === 'dark') {
      darkToggle.checked = true;
      document.body.classList.remove('light-mode');
    } else {
      darkToggle.checked = false;
      document.body.classList.add('light-mode');
    }

    const fontStored = localStorage.getItem('fontFamily');
    if (fontStored) {
      fontSelect.value = fontStored;
      document.body.style.fontFamily = fontStored;
    }
  }
  function createTableRow(dateStr, value) {
    const tr = document.createElement('tr');

    // Datum
    const tdDate = document.createElement('td');
    tdDate.textContent = dateStr;
    tr.appendChild(tdDate);

    // Eingabefeld
    const tdInput = document.createElement('td');
    const input = document.createElement('input');
    input.type = 'text';
    input.value = value;
    input.dataset.date = dateStr;
    tdInput.appendChild(input);
    tr.appendChild(tdInput);

    input.addEventListener('input', () => {
      // Wert nur Zahlen
      let val = input.value.replace(/\D/g, '');
      input.value = val;

      // Aktualisieren in allInputs
      const idx = allInputs.findIndex(e => e.date === dateStr);
      if (idx >= 0) {
        allInputs[idx].value = val;
      } else {
        allInputs.push({ date: dateStr, value: val });
      }
      highlightRow(tr);
      saveData();
      updateStats();
      updateProgressBar();
      updateChart();
    });

    return tr;
  }
  function highlightRow(row) {
    row.classList.add('highlight');
    setTimeout(() => row.classList.remove('highlight'), 1500);
  }
  function updateTable(filterDate = null) {
    tableBody.innerHTML = '';
    let filtered = allInputs.slice();

    if (filterDate) {
      filtered = filtered.filter(e => e.date === filterDate);
      if (filtered.length === 0) {
        statsBox.innerHTML = <em>Keine Eintr√§ge f√ºr den ${filterDate}.</em>;
      }
    } else {
      // Sortieren nach Datum aufsteigend
      filtered.sort((a,b) => {
        const d1 = parseDateString(a.date);
        const d2 = parseDateString(b.date);
        return d1 - d2;
      });
    }

    for (const item of filtered) {
      tableBody.appendChild(createTableRow(item.date, item.value));
    }
  }
  function updateStats() {
    if (allInputs.length === 0) {
      statsBox.innerHTML = "<em>Keine Daten vorhanden.</em>";
      return;
    }
    // Filter aktuell nach Filter-Auswahl
    let filtered = applyDateFilter(allInputs);

    if (filtered.length === 0) {
      statsBox.innerHTML = "<em>Keine Daten im gew√§hlten Zeitraum.</em>";
      return;
    }

    let maxVal = 0;
    let minVal = Number.MAX_SAFE_INTEGER;
    let sum = 0;
    let maxDate = '';
    let minDate = '';

    for (const e of filtered) {
      const val = parseInt(e.value) || 0;
      if (val > maxVal) {
        maxVal = val;
        maxDate = e.date;
      }
      if (val < minVal) {
        minVal = val;
        minDate = e.date;
      }
      sum += val;
    }
    const avg = (sum / filtered.length).toFixed(1);
    statsBox.innerHTML = `
      <p><strong>Maximaler Wert:</strong> ${maxVal} Liegest√ºtze am ${maxDate}</p>
      <p><strong>Minimaler Wert:</strong> ${minVal} Liegest√ºtze am ${minDate}</p>
      <p><strong>Durchschnitt:</strong> ${avg} Liegest√ºtze</p>
      <p><strong>Eintr√§ge:</strong> ${filtered.length}</p>
      <p><strong>Tagesziel:</strong> ${dailyTarget} Liegest√ºtze</p>
    `;
  }
  function updateProgressBar() {
    // Aktueller Tag
    const todayStr = formatDate(new Date());
    const todayEntry = allInputs.find(e => e.date === todayStr);
    let val = todayEntry ? parseInt(todayEntry.value) || 0 : 0;
    let percent = Math.min(100, (val / dailyTarget) * 100);
    progressBar.style.width = percent + '%';
    progressBar.textContent = Math.round(percent) + '%';
    if (percent >= 100) {
      progressBar.style.background = 'linear-gradient(90deg, #00ff00, #007f00)';
      showNotification("Herzlichen Gl√ºckwunsch! Tagesziel erreicht!");
    } else {
      progressBar.style.background = 'linear-gradient(90deg, #00ffcc, #007f7f)';
    }
  }
  function applyDateFilter(data) {
    const val = dateFilter.value;
    if (val === 'all') return data;
    const days = parseInt(val);
    const now = new Date();
    const filtered = data.filter(e => {
      const d = parseDateString(e.date);
      if (!d) return false;
      return (now - d) <= days * 86400000; // ms in day
    });
    return filtered;
  }
  function updateChart() {
    const filtered = applyDateFilter(allInputs);
    const sorted = filtered.slice().sort((a,b) => {
      const d1 = parseDateString(a.date);
      const d2 = parseDateString(b.date);
      return d1 - d2;
    });
    const labels = sorted.map(e => e.date);
    const values = sorted.map(e => parseInt(e.value) || 0);

    if (progressChart) progressChart.destroy();

    progressChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Liegest√ºtze',
          data: values,
          fill: true,
          backgroundColor: 'rgba(0,255,204,0.2)',
          borderColor: 'rgba(0,255,204,1)',
          borderWidth: 3,
          tension: 0.25,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: 'rgba(0,255,204,1)',
          pointBorderColor: '#004d40'
        }]
      },
      options: {
        responsive: true,
        animation: {
          duration: 700,
          easing: 'easeInOutQuad'
        },
        scales: {
          y: {
            beginAtZero: true,
            suggestedMax: dailyTarget + 20,
            ticks: { stepSize: 10 }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: document.body.classList.contains('light-mode') ? '#007f7f' : '#7df9ff',
              font: { size: 14 }
            }
          }
        }
      }
    });
  }

  // --- Init-Daten (erstes Laden) ---
  function init() {
    loadData();

    // Initial t√§gliches Ziel anzeigen
    dailyTargetInput.value = dailyTarget;

    // Ersten Aufruf mit Filter "Alle"
    updateTable();
    updateStats();
    updateProgressBar();
    updateChart();

    // Schriftart setzen
    document.body.style.fontFamily = fontSelect.value;
  }
  init();

  // --- Eventlistener ---
  settingsIcon.addEventListener('click', () => {
    if (settingsMenu.style.display === 'block') {
      settingsMenu.style.display = 'none';
    } else {
      settingsMenu.style.display = 'block';
    }
  });

  notificationToggle.addEventListener('click', () => {
    notificationToggleMenu.style.display = notificationToggleMenu.style.display === 'block' ? 'none' : 'block';
  });

  enableNotificationsCheckbox.addEventListener('change', () => {
    saveData();
  });

  darkToggle.addEventListener('change', () => {
    if (darkToggle.checked) {
      document.body.classList.remove('light-mode');
    } else {
      document.body.classList.add('light-mode');
    }
    saveData();
    updateChart();
  });

  dailyTargetInput.addEventListener('change', () => {
    let val = parseInt(dailyTargetInput.value);
    if (isNaN(val) || val < 1) val = 50;
    dailyTarget = val;
    dailyTargetInput.value = dailyTarget;
    saveData();
    updateStats();
    updateProgressBar();
    updateChart();
  });

  fontSelect.addEventListener('change', () => {
    document.body.style.fontFamily = fontSelect.value;
    saveData();
  });

  exportBtn.addEventListener('click', () => {
    if (allInputs.length === 0) {
      alert("Keine Daten zum Exportieren vorhanden.");
      return;
    }
    const csvContent = "data:text/csv;charset=utf-8," +
      ["Datum,Liegest√ºtze"].concat(allInputs.map(e => ${e.date},${e.value})).join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "liegestuetz_daten.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });

  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const val = searchInput.value.trim();
      if (!val) {
        updateTable();
        updateStats();
        updateProgressBar();
        updateChart();
        return;
      }
      const d = parseDateString(val);
      if (!d) {
        alert('Ung√ºltiges Datumsformat! Bitte im Format TT.MM.JJJJ eingeben.');
        return;
      }
      const dateStr = formatDate(d);
      updateTable(dateStr);
      updateStats();
      updateProgressBar();
      updateChart();
    }
  });

  dateFilter.addEventListener('change', () => {
    updateStats();
    updateChart();
    updateTable();
  });

</script>
</body>
</html>
