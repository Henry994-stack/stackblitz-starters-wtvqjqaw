<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Liegestütz Tracker</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #121212;
    color: #7df9ff;
    margin: 0;
    padding: 20px;
    transition: background-color 0.3s, color 0.3s;
  }
  body.light-mode {
    background-color: #f0f0f0;
    color: #007f7f;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #settings-icon {
    cursor: pointer;
    font-size: 24px;
    user-select: none;
    color: inherit;
  }
  #settings-menu {
    position: absolute;
    top: 50px;
    right: 20px;
    background: rgba(0,0,0,0.8);
    border-radius: 8px;
    padding: 15px;
    display: none;
    width: 220px;
    color: #7df9ff;
    z-index: 100;
  }
  body.light-mode #settings-menu {
    background: #ddd;
    color: #007f7f;
  }
  #notification-toggle-menu {
    margin-top: 10px;
    background: rgba(0,0,0,0.6);
    padding: 10px;
    border-radius: 6px;
    display: none;
  }
  body.light-mode #notification-toggle-menu {
    background: #bbb;
  }
  label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
  }
  input[type="checkbox"] {
    transform: scale(1.3);
  }
  select, input[type="number"], input[type="text"] {
    width: 100%;
    margin-top: 5px;
    margin-bottom: 15px;
    padding: 5px;
    border-radius: 4px;
    border: 1px solid #007f7f;
    background-color: transparent;
    color: inherit;
  }
  body.light-mode select, body.light-mode input[type="number"], body.light-mode input[type="text"] {
    border-color: #007f7f;
    background-color: #fff;
    color: #007f7f;
  }
  button {
    background-color: #00ffcc;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    color: #004d40;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  button:hover {
    background-color: #00cc99;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th, td {
    padding: 8px;
    border-bottom: 1px solid #007f7f;
    text-align: center;
  }
  body.light-mode th, body.light-mode td {
    border-color: #004d40;
  }
  #progress-bar-container {
    width: 100%;
    background-color: #444;
    border-radius: 12px;
    overflow: hidden;
    margin-top: 20px;
    height: 25px;
  }
  #progress-bar {
    height: 100%;
    background-color: #00ffcc;
    width: 0%;
    transition: width 0.5s ease-in-out;
  }
  #chart-container {
    margin-top: 30px;
  }
</style>
</head>
<body class="dark-mode">
<header>
  <h1>Liegestütz Tracker</h1>
  <div id="settings-icon" title="Einstellungen">&#9881;</div>
</header>

<div id="settings-menu" role="menu" aria-label="Einstellungen Menü">
  <label for="dark-toggle">
    <input type="checkbox" id="dark-toggle" />
    Dark Mode aktivieren
  </label>

  <label for="date-filter">
    Zeitraum filtern:
    <select id="date-filter" aria-label="Zeitraum Filter">
      <option value="all">Alle Einträge</option>
      <option value="7">Letzte 7 Tage</option>
      <option value="30">Letzte 30 Tage</option>
      <option value="90">Letzte 90 Tage</option>
    </select>
  </label>

  <label for="daily-target">
    Tagesziel Liegestütze:
    <input type="number" id="daily-target" min="1" max="1000" />
  </label>

  <label for="font-select">
    Schriftart:
    <select id="font-select" aria-label="Schriftart Auswahl">
      <option value="Arial, sans-serif">Arial</option>
      <option value="'Courier New', monospace">Courier New</option>
      <option value="'Georgia', serif">Georgia</option>
      <option value="'Times New Roman', serif">Times New Roman</option>
      <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
      <option value="'Verdana', sans-serif">Verdana</option>
    </select>
  </label>

  <label id="notification-toggle" style="cursor:pointer; user-select:none;">
    Benachrichtigungen &nbsp;&#x25BC;
  </label>
  <div id="notification-toggle-menu" role="menu" aria-label="Benachrichtigungs Optionen">
    <label for="enable-notifications">
      <input type="checkbox" id="enable-notifications" />
      Benachrichtigungen aktivieren
    </label>
  </div>

  <button id="export-btn" aria-label="Daten exportieren">Daten exportieren</button>
</div>

<div style="margin-top: 20px;">
  <input type="text" id="search-input" placeholder="Nach Datum suchen (TT.MM.JJJJ)" aria-label="Datum Suche" />
</div>

<table aria-label="Eingabedaten Tabelle" id="data-table">
  <thead>
    <tr><th>Datum</th><th>Liegestütze</th></tr>
  </thead>
  <tbody>
  </tbody>
</table>

<div id="progress-bar-container" aria-label="Fortschrittsbalken">
  <div id="progress-bar"></div>
</div>

<div id="chart-container">
  <canvas id="progress-chart" aria-label="Fortschrittsdiagramm"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const settingsIcon = document.getElementById('settings-icon');
  const settingsMenu = document.getElementById('settings-menu');
  const notificationToggle = document.getElementById('notification-toggle');
  const notificationToggleMenu = document.getElementById('notification-toggle-menu');
  const enableNotificationsCheckbox = document.getElementById('enable-notifications');
  const darkToggle = document.getElementById('dark-toggle');
  const dateFilter = document.getElementById('date-filter');
  const dailyTargetInput = document.getElementById('daily-target');
  const fontSelect = document.getElementById('font-select');
  const exportBtn = document.getElementById('export-btn');
  const searchInput = document.getElementById('search-input');
  const dataTableBody = document.querySelector('#data-table tbody');
  const progressBar = document.getElementById('progress-bar');
  const ctx = document.getElementById('progress-chart').getContext('2d');

  let allInputs = [];
  let dailyTarget = 30;
  let progressChart = null;

  // Beispiel-Daten (kann leer sein, falls eigene Daten gewünscht)
  if (!localStorage.getItem('liegestuetzData')) {
    allInputs = [
      { date: '01.06.2025', value: '20' },
      { date: '02.06.2025', value: '25' },
      { date: '03.06.2025', value: '30' },
      { date: '04.06.2025', value: '35' },
      { date: '05.06.2025', value: '40' },
    ];
    localStorage.setItem('liegestuetzData', JSON.stringify(allInputs));
  }

  function parseDateString(str) {
    const parts = str.split('.');
    if (parts.length !== 3) return null;
    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10) - 1;
    const year = parseInt(parts[2], 10);
    return new Date(year, month, day);
  }

  function loadData() {
    const saved = localStorage.getItem('liegestuetzData');
    if (saved) {
      allInputs = JSON.parse(saved);
    }
    const savedTarget = localStorage.getItem('dailyTarget');
    if (savedTarget) {
      dailyTarget = parseInt(savedTarget);
      dailyTargetInput.value = dailyTarget;
    } else {
      dailyTargetInput.value = dailyTarget;
    }
    const darkMode = localStorage.getItem('darkMode');
    if (darkMode === 'true') {
      document.body.classList.remove('light-mode');
      darkToggle.checked = true;
    } else {
      document.body.classList.add('light-mode');
      darkToggle.checked = false;
    }
    const font = localStorage.getItem('font');
    if (font) {
      fontSelect.value = font;
      document.body.style.fontFamily = font;
    }
    const notificationsEnabled = localStorage.getItem('notificationsEnabled');
    if (notificationsEnabled === 'true') {
      enableNotificationsCheckbox.checked = true;
    } else {
      enableNotificationsCheckbox.checked = false;
    }
  }

  function saveData() {
    localStorage.setItem('liegestuetzData', JSON.stringify(allInputs));
    localStorage.setItem('dailyTarget', dailyTarget);
    localStorage.setItem('darkMode', darkToggle.checked);
    localStorage.setItem('font', fontSelect.value);
    localStorage.setItem('notificationsEnabled', enableNotificationsCheckbox.checked);
  }

  function renderTable(filteredData) {
    dataTableBody.innerHTML = '';
    filteredData.forEach(item => {
      const tr = document.createElement('tr');
      const tdDate = document.createElement('td');
      const tdValue = document.createElement('td');
      tdDate.textContent = item.date;
      tdValue.textContent = item.value;
      tr.appendChild(tdDate);
      tr.appendChild(tdValue);
      dataTableBody.appendChild(tr);
    });
  }

  function updateProgressBar() {
    const today = new Date();
    const todayStr = `${String(today.getDate()).padStart(2, '0')}.${String(today.getMonth()+1).padStart(2,'0')}.${today.getFullYear()}`;

    // Suche aktuellen Eintrag
    const todayEntry = allInputs.find(e => e.date === todayStr);
    const value = todayEntry ? parseInt(todayEntry.value) : 0;
    const percent = Math.min((value / dailyTarget) * 100, 100);
    progressBar.style.width = percent + '%';
  }

  function filterDataByDateRange(rangeDays) {
    if (rangeDays === 'all') return allInputs;

    const today = new Date();
    const fromDate = new Date(today);
    fromDate.setDate(today.getDate() - parseInt(rangeDays));
    return allInputs.filter(e => {
      const d = parseDateString(e.date);
      return d && d >= fromDate && d <= today;
    });
  }

  function filterDataBySearch(query, data) {
    if (!query) return data;
    return data.filter(e => e.date.includes(query));
  }

  function updateChart(filteredData) {
    // Sortiere nach Datum
    filteredData.sort((a,b) => {
      const da = parseDateString(a.date);
      const db = parseDateString(b.date);
      return da - db;
    });
    const labels = filteredData.map(e => e.date);
    const values = filteredData.map(e => parseInt(e.value));

    const isDark = !document.body.classList.contains('light-mode');
    const textColor = isDark ? '#7df9ff' : '#007f7f';
    const gridColor = isDark ? '#004d40' : '#a0d0d0';

    if (progressChart) progressChart.destroy();
    progressChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Liegestütze',
          data: values,
          borderColor: '#00ffcc',
          backgroundColor: 'rgba(0,255,204,0.3)',
          fill: true,
          tension: 0.2,
          pointRadius: 4,
          pointBackgroundColor: '#00ffcc',
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: gridColor
            },
            ticks: {
              color: textColor
            }
          },
          x: {
            grid: {
              color: gridColor
            },
            ticks: {
              color: textColor
            }
          }
        },
        plugins: {
          legend: {
            labels: { color: textColor }
          }
        }
      }
    });
  }

  function updateAll() {
    let filtered = filterDataByDateRange(dateFilter.value);
    filtered = filterDataBySearch(searchInput.value.trim(), filtered);
    renderTable(filtered);
    updateProgressBar();
    updateChart(filtered);
  }

  function toggleSettingsMenu() {
    if (settingsMenu.style.display === 'block') {
      settingsMenu.style.display = 'none';
      notificationToggleMenu.style.display = 'none';
    } else {
      settingsMenu.style.display = 'block';
    }
  }

  function toggleNotificationMenu() {
    if (notificationToggleMenu.style.display === 'block') {
      notificationToggleMenu.style.display = 'none';
    } else {
      notificationToggleMenu.style.display = 'block';
    }
  }

  function exportData() {
    const dataStr = JSON.stringify(allInputs, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'liegestuetz-data.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  // Benachrichtigungsfunktion (Browser Notifications)
  function notifyIfNeeded() {
    if (!enableNotificationsCheckbox.checked) return;

    if (!("Notification" in window)) return; // Browser unterstützt keine Notification

    if (Notification.permission === "granted") {
      sendNotification();
    } else if (Notification.permission !== "denied") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") sendNotification();
      });
    }
  }

  function sendNotification() {
    const today = new Date();
    const todayStr = `${String(today.getDate()).padStart(2, '0')}.${String(today.getMonth()+1).padStart(2,'0')}.${today.getFullYear()}`;
    const todayEntry = allInputs.find(e => e.date === todayStr);
    const value = todayEntry ? parseInt(todayEntry.value) : 0;

    if (value < dailyTarget) {
      const diff = dailyTarget - value;
      new Notification('Liegestütz Tracker', {
        body: `Du hast heute noch ${diff} Liegestütze bis zum Ziel.`,
        icon: 'https://cdn-icons-png.flaticon.com/512/1916/1916671.png'
      });
    }
  }

  // Event-Listener
  settingsIcon.addEventListener('click', toggleSettingsMenu);
  notificationToggle.addEventListener('click', toggleNotificationMenu);

  darkToggle.addEventListener('change', () => {
    if (darkToggle.checked) {
      document.body.classList.remove('light-mode');
    } else {
      document.body.classList.add('light-mode');
    }
    saveData();
    updateChart(filterDataByDateRange(dateFilter.value));
  });

  dateFilter.addEventListener('change', () => {
    updateAll();
  });

  dailyTargetInput.addEventListener('change', () => {
    let val = parseInt(dailyTargetInput.value);
    if (isNaN(val) || val < 1) val = 1;
    if (val > 1000) val = 1000;
    dailyTarget = val;
    dailyTargetInput.value = val;
    saveData();
    updateProgressBar();
  });

  fontSelect.addEventListener('change', () => {
    document.body.style.fontFamily = fontSelect.value;
    saveData();
  });

  enableNotificationsCheckbox.addEventListener('change', () => {
    saveData();
    if (enableNotificationsCheckbox.checked) {
      notifyIfNeeded();
    }
  });

  exportBtn.addEventListener('click', () => {
    exportData();
  });

  searchInput.addEventListener('keyup', e => {
    if (e.key === 'Enter') {
      updateAll();
    }
  });

  // Initialisierung
  loadData();
  updateAll();

  // Optionale tägliche Benachrichtigung z.B. beim Laden
  notifyIfNeeded();

</script>
</body>
</html>
