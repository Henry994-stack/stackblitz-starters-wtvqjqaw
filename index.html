<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>Liegest√ºtz-Tracker</title>
    <!-- iPhone App-Icon -->
    <link rel="apple-touch-icon" href="icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <style>
      /* Styles unver√§ndert, lasse ich hier weg zum K√ºrzen */
    </style>
  </head>
  <body>
    <h1>Liegest√ºtz-Tracker</h1>

    <div id="settingsIcon">‚öô</div>
    <div id="settingsMenu">
      <ul>
        <li id="notificationToggle">üîî Benachrichtigungen</li>
      </ul>
      <div id="notificationToggleMenu">
        <label>
          <input type="checkbox" id="enableNotifications" /> Benachrichtigungen aktivieren
        </label>
      </div>
    </div>

    <div id="statsBox"></div>

    <div style="text-align: center; margin: 10px 0;">
      <button id="exportBtn">üìÅ Daten exportieren</button>
      <label style="margin-left: 20px;">
        <input type="checkbox" id="darkModeToggle" checked /> üåô Dark Mode
      </label>
      <select id="dateFilter" style="margin-left: 20px;">
        <option value="all">Alle</option>
        <option value="7">Letzte 7 Tage</option>
        <option value="30">Letzte 30 Tage</option>
        <option value="365">Letztes Jahr</option>
      </select>
    </div>

    <div
      id="progressBarContainer"
      style="width: 100%; max-width: 600px; margin: 0 auto 20px; background: #444; border-radius: 10px; overflow: hidden;"
    >
      <div
        id="progressBar"
        style="height: 20px; width: 0%; background: linear-gradient(to right, #00ffcc, #007f7f); text-align: right; color: #fff; font-size: 12px; padding-right: 5px;"
      ></div>
    </div>

    <input
      type="text"
      id="searchInput"
      placeholder="Datum eingeben (z.‚ÄØB. 29.06.2025) & Enter dr√ºcken"
    />

    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>Liegest√ºtze</th>
        </tr>
      </thead>
      <tbody id="trackerTable"></tbody>
    </table>

    <script>
      const tableBody = document.getElementById('trackerTable');
      const statsBox = document.getElementById('statsBox');
      const searchInput = document.getElementById('searchInput');
      const settingsIcon = document.getElementById('settingsIcon');
      const settingsMenu = document.getElementById('settingsMenu');
      const notificationToggle = document.getElementById('notificationToggle');
      const notificationToggleMenu = document.getElementById('notificationToggleMenu');
      const enableNotificationsCheckbox = document.getElementById('enableNotifications');
      const darkToggle = document.getElementById('darkModeToggle');
      const exportBtn = document.getElementById('exportBtn');
      const dateFilter = document.getElementById('dateFilter');
      const progressBar = document.getElementById('progressBar');

      const startDate = new Date();
      const endDate = new Date(startDate);
      endDate.setFullYear(endDate.getFullYear() + 5);

      const allInputs = [];

      function formatDate(date) {
        const d = String(date.getDate()).padStart(2, '0');
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const y = date.getFullYear();
        return `${d}.${m}.${y}`;
      }

      function formatId(date) {
        const d = String(date.getDate()).padStart(2, '0');
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const y = date.getFullYear();
        return `row_${d}${m}${y}`;
      }

      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateCopy = new Date(d);
        const formatted = formatDate(d);
        const id = formatId(d);
        let savedValue = localStorage.getItem(id);
        const now = new Date();
        if (!savedValue) {
          if (dateCopy < new Date(now.getFullYear(), now.getMonth(), now.getDate())) {
            savedValue = '/';
          } else {
            savedValue = '';
          }
        }
        const tr = document.createElement('tr');
        tr.id = id;
        tr.innerHTML = `<td>${formatted}</td><td><input type="text" value="${savedValue}" data-id="${id}" maxlength="4" /></td>`;
        tableBody.appendChild(tr);
        allInputs.push({ date: dateCopy, id });
      }

      document.addEventListener('input', (e) => {
        if (e.target && e.target.tagName === 'INPUT') {
          const id = e.target.dataset.id;
          const val = e.target.value.trim();
          if (val === '' || /^[0-9]+$/.test(val)) {
            localStorage.setItem(id, val);
            updateStats();
          }
        }
      });

      searchInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          const val = this.value.trim().replace(/\./g, '');
          const rowId = 'row_' + val;
          const row = document.getElementById(rowId);
          if (row) {
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            row.classList.add('highlight');
            setTimeout(() => row.classList.remove('highlight'), 1500);
          } else {
            alert('Kein Eintrag f√ºr dieses Datum gefunden.');
          }
        }
      });

      function updateStats() {
        const now = new Date();
        let sum7 = 0,
          sum30 = 0,
          sum365 = 0,
          sumAll = 0;
        let todayId = formatId(now);
        let todayCount = parseInt(localStorage.getItem(todayId) || '0', 10);

        allInputs.forEach(({ date, id }) => {
          let valStr = localStorage.getItem(id) || '';
          if (valStr === '/') valStr = '0';
          const val = parseInt(valStr, 10);
          if (!isNaN(val)) {
            const diffDays = (now - date) / (1000 * 60 * 60 * 24);
            if (diffDays <= 7) sum7 += val;
            if (diffDays <= 30) sum30 += val;
            if (diffDays <= 365) sum365 += val;
            sumAll += val;
          }
        });

        let motivation = '';
        if (todayCount === 0) {
          motivation = '<em>Du hast heute noch keine Liegest√ºtze gemacht. Los geht\'s! üí™</em>';
        } else if (todayCount < 20) {
          motivation = '<em>Guter Start heute! Weiter so! üî•</em>';
        } else if (todayCount < 50) {
          motivation = '<em>Stark! Du machst Fortschritte! üöÄ</em>';
        } else {
          motivation = '<em>Wow! Du bist richtig fit! üëè</em>';
        }

        statsBox.innerHTML = `
          <p><strong>Letzte 7 Tage:</strong> ${sum7} Liegest√ºtze</p>
          <p><strong>Letzte 30 Tage:</strong> ${sum30} Liegest√ºtze</p>
          <p><strong>Letztes Jahr:</strong> ${sum365} Liegest√ºtze</p>
          <p><strong>Gesamt:</strong> ${sumAll} Liegest√ºtze</p>
          <p>${motivation}</p>
        `;

        updateProgressBar(sumAll);
      }

      function updateProgressBar(total) {
        const percent = Math.min((total / 1000) * 100, 100); // Ziel: 1000 Liegest√ºtze
        progressBar.style.width = `${percent}%`;
        progressBar.textContent = `${Math.round(percent)}%`;
      }

      // Dark Mode Toggle
      darkToggle.addEventListener('change', () => {
        if (darkToggle.checked) {
          document.body.style.backgroundColor = '#1c1c1c';
          document.body.style.color = '#f0f0f0';
        } else {
          document.body.style.backgroundColor = '#f0f0f0';
          document.body.style.color = '#1c1c1c';
        }
      });

      // Daten exportieren
      exportBtn.addEventListener('click', () => {
        let csv = 'Datum,Liegest√ºtze\n';
        allInputs.forEach(({ date, id }) => {
          const datum = formatDate(date);
          let val = localStorage.getItem(id) || '';
          if (val === '/') val = '';
          csv += `${datum},${val}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'liegestuetz-daten.csv';
        a.click();
        URL.revokeObjectURL(url);
      });

      // Datumsbereich filtern
      dateFilter.addEventListener('change', (e) => {
        const filter = e.target.value;
        const now = new Date();

        allInputs.forEach(({ date, id }) => {
          const row = document.getElementById(id);
          const diffDays = (now - date) / (1000 * 60 * 60 * 24);
          if (
            filter === 'all' ||
            (filter === '7' && diffDays <= 7) ||
            (filter === '30' && diffDays <= 30) ||
            (filter === '365' && diffDays <= 365)
          ) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      });

      // Einstellungen Men√º (Zahnrad)
      settingsIcon.addEventListener('click', () => {
        settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
        notificationToggleMenu.style.display = 'none';
      });

      // Benachrichtigungen Untermen√º
      notificationToggle.addEventListener('click', () => {
        if (notificationToggleMenu.style.display === 'block') {
          notificationToggleMenu.style.display = 'none';
        } else {
          notificationToggleMenu.style.display = 'block';
        }
      });

      // Lade Dark Mode Einstellung vom LocalStorage
      const darkModeStored = localStorage.getItem('darkMode');
      if (darkModeStored === 'true') {
        darkToggle.checked = true;
        document.body.style.backgroundColor = '#1c1c1c';
        document.body.style.color = '#f0f0f0';
      } else {
        darkToggle.checked = false;
        document.body.style.backgroundColor = '#f0f0f0';
        document.body.style.color = '#1c1c1c';
      }

      darkToggle.addEventListener('change', () => {
        if (darkToggle.checked) {
          localStorage.setItem('darkMode', 'true');
          document.body.style.backgroundColor = '#1c1c1c';
          document.body.style.color = '#f0f0f0';
        } else {
          localStorage.setItem('darkMode', 'false');
          document.body.style.backgroundColor = '#f0f0f0';
          document.body.style.color = '#1c1c1c';
        }
      });

      // Benachrichtigungen aktivieren/deaktivieren (nur lokal gespeichert)
      enableNotificationsCheckbox.checked = localStorage.getItem('notificationsEnabled') === 'true';
      enableNotificationsCheckbox.addEventListener('change', () => {
        localStorage.setItem('notificationsEnabled', enableNotificationsCheckbox.checked ? 'true' : 'false');
      });

      updateStats();
    </script>
  </body>
</html>
